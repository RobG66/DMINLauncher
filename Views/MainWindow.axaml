<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:DMINLauncher.ViewModels"
        xmlns:conv="using:DMINLauncher.Converters"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="850" d:DesignHeight="700"
        x:Class="DMINLauncher.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="{Binding AppVersion, StringFormat='DMINLauncher v{0}'}"
        Width="{Binding WindowWidth}" Height="{Binding WindowHeight}"
        MinWidth="400" MinHeight="350"
        MaxWidth="1600" MaxHeight="1400"
        Icon="/Assets/doom.ico">

    <Window.Resources>
        <conv:DifficultyDisplayConverter x:Key="DifficultyDisplay"/>
        <conv:GameTypeDisplayConverter x:Key="GameTypeDisplay"/>
        <conv:NetworkModeDisplayConverter x:Key="NetworkModeDisplay"/>
        <conv:HexenClassDisplayConverter x:Key="HexenClassDisplay"/>
    </Window.Resources>

    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+Add" Command="{Binding ZoomInCommand}"/>
        <KeyBinding Gesture="Ctrl+Subtract" Command="{Binding ZoomOutCommand}"/>
        <KeyBinding Gesture="Ctrl+D0" Command="{Binding ResetZoomCommand}"/>
        <KeyBinding Gesture="Ctrl+NumPad0" Command="{Binding ResetZoomCommand}"/>
        <KeyBinding Gesture="Escape" Command="{Binding ShowExitConfirmationCommand}"/>
    </Window.KeyBindings>

    <Window.Styles>
        <Style Selector="RadioButton /template/ Ellipse">
            <Setter Property="Width" Value="10"/>
            <Setter Property="Height" Value="10"/>
        </Style>
        <Style Selector="RadioButton /template/ Ellipse.OuterEllipse">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
        </Style>
        
        <!-- Nice compact tabs -->
        <Style Selector="TabItem">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#B0B0B0"/>
        </Style>
        <Style Selector="TabItem:selected">
            <Setter Property="Foreground" Value="#D2B48C"/>
        </Style>
        <Style Selector="TabItem:pointerover">
            <Setter Property="Foreground" Value="#E0E0E0"/>
        </Style>
        
        <!-- Remove default TabControl content padding -->
        <Style Selector="TabControl">
            <Setter Property="Padding" Value="0"/>
        </Style>
        <Style Selector="TabControl /template/ Border#PART_SelectedContentHost">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>
    </Window.Styles>

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <!-- Viewbox scales content to fill the window -->
    <Viewbox Stretch="Uniform">
        <Panel Width="850" Height="700">
            <!-- Subtle Background Image -->
            <Image Source="/Assets/wallpaper.jpg" 
                   Stretch="UniformToFill" 
                   Opacity="0.45"/>
            
            <!-- Semi-transparent overlay for better readability -->
            <Border Background="#A0202020"/>

            <!-- Main Content Grid -->
            <Grid Margin="10" RowDefinitions="Auto,*,Auto">
      
            <!-- Main Content - Always Visible Top Section + Tabs Below -->
            <StackPanel Grid.Row="1" Margin="10" Spacing="15">
                <!-- Top 4 Borders: Always Visible -->
                <!-- Directory Selection - Side by Side -->
                            <Grid ColumnDefinitions="*,10,*">
                                <!-- WADs Directory -->
                                <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="5"
                                        Background="#40404040">
                                    <StackPanel Spacing="3">
                                        <TextBlock Text="WADs &amp; Mods Location" Foreground="Tan" FontWeight="Bold"/>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBox Grid.Column="0" Text="{Binding DataDirectory}" 
                                                     Watermark="Type or click Browse to set WADs directory..."
                                                     ToolTip.Tip="{Binding DataDirectory}"
                                                     VerticalContentAlignment="Center"/>
                                            <Button Grid.Column="1"
                                                    Background="Transparent"
                                                    Command="{Binding ChangeDataDirectoryCommand}"
                                                    ToolTip.Tip="Browse for WADS directory"
                                                    Margin="5,0,0,0" Padding="0">
                                            <Image Source="/Assets/folder.png" Width="20" Height="20"/>    
                                            </Button>

                                        </Grid>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Engine Executable -->
                                <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="5"
                                        Background="#40404040">
                                    <StackPanel Spacing="3">
                                        <!-- Header with inline radio buttons -->
                                        <Grid ColumnDefinitions="Auto,10,*">
                                            <TextBlock Grid.Column="0" Text="Engine Selection" Foreground="Tan" FontWeight="Bold" VerticalAlignment="Center"/>
                                            
                                            <!-- Radio buttons (Linux only) -->
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="15" IsVisible="{Binding IsLinux}">
                                                <RadioButton Content="File Path"
                                                             Foreground="LightGreen"
                                                             IsChecked="{Binding UseFilePathEngine}"
                                                             GroupName="EngineMode"
                                                             FontSize="11"/>
                                                <RadioButton Content="Flatpak Application"
                                                             Foreground="LightGreen"
                                                             IsChecked="{Binding UseFlatpakEngine}"
                                                             GroupName="EngineMode"
                                                             FontSize="11"/>
                                            </StackPanel>
                                        </Grid>
                                        
                                        <!-- File Path Input (shown when File Path selected) -->
                                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding UseFilePathEngine}">
                                            <TextBox Grid.Column="0" 
                                                     Text="{Binding EngineExecutable}" 
                                                     Watermark="Type or browse for engine executable..."
                                                     ToolTip.Tip="{Binding EngineExecutable}"
                                                     VerticalContentAlignment="Center"/>
                                            <Button Grid.Column="1"
                                                    Background="Transparent"
                                                    ToolTip.Tip="Browse for engine executable"
                                                    Command="{Binding ChangeEngineExecutableCommand}"
                                                    Margin="5,0,0,0" Padding="0">
                                                <Image Source="/Assets/folder.png" Width="20" Height="20"/>
                                            </Button>
                                        </Grid>
                                        
                                        <!-- Flatpak Input (shown when Flatpak selected) -->
                                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding UseFlatpakEngine}">
                                            <TextBox Grid.Column="0" 
                                                     Text="{Binding EngineExecutable}" 
                                                     Watermark="Select Flatpak application..."
                                                     ToolTip.Tip="{Binding EngineExecutable}"
                                                     IsReadOnly="True"
                                                     VerticalContentAlignment="Center"/>
                                            <Button Grid.Column="1"
                                                    Background="Transparent"
                                                    ToolTip.Tip="Select Flatpak application"
                                                    Command="{Binding AddCustomFlatpakCommand}"
                                                    Margin="5,0,0,0" Padding="0">
                                                 <Image Source="/Assets/flatpak.png" Width="20" Height="20"/>
                                           </Button>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Base Game and Difficulty Selection - Side by Side -->
                            <Grid ColumnDefinitions="*,10,*">
                                <!-- Base Game Selection -->
                                <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="5">
                                    <StackPanel Spacing="3">
                                        <!-- Header with Maps button -->
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Grid.Column="0" 
                                                       Text="Base Game Selection (IWAD)" 
                                                       Foreground="Tan" 
                                                       FontWeight="Bold"
                                                       VerticalAlignment="Center"/>
                                            <Button Grid.Column="1" 
                                                    IsVisible="{Binding SelectedBaseGame.MapList, Converter={x:Static ObjectConverters.IsNotNull}}"
                                                    Content="Show Maps"
                                                    FontSize="10"
                                                    Padding="6,2"
                                                    Background="#40404040"
                                                    Foreground="LightBlue">
                                                <Button.Flyout>
                                                    <Flyout Placement="Bottom">
                                                        <Border Background="#E0202020" 
                                                                BorderBrush="Gray" 
                                                                BorderThickness="1" 
                                                                CornerRadius="5"
                                                                Padding="10"
                                                                MaxWidth="400"
                                                                MaxHeight="300">
                                                            <ScrollViewer>
                                                                <TextBlock Text="{Binding SelectedBaseGame.MapList}" 
                                                                           FontSize="11" 
                                                                           Foreground="White"
                                                                           TextWrapping="Wrap"/>
                                                            </ScrollViewer>
                                                        </Border>
                                                    </Flyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>
                                        
                                        <ComboBox ItemsSource="{Binding WadFiles}" 
                                                  SelectedItem="{Binding SelectedBaseGame}"
                                                  HorizontalAlignment="Stretch">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel ToolTip.Tip="{Binding MapList}">
                                                        <TextBlock Text="{Binding RelativePath}" FontWeight="Medium"/>
                                                        <TextBlock Text="{Binding Stats}" FontSize="10" Foreground="Gray"/>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        
                                        <!-- Hexen Class Selection -->
                                        <StackPanel Spacing="3" IsVisible="{Binding ShowHexenClassSelection}" Margin="0,8,0,0">
                                            <TextBlock Text="Hexen Character Class" Foreground="Tan" FontWeight="Bold"/>
                                            <ComboBox ItemsSource="{Binding HexenClassOptions}"
                                                      SelectedItem="{Binding HexenClass}"
                                                      HorizontalAlignment="Stretch">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Converter={StaticResource HexenClassDisplay}}"/>
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>

                                <!-- Difficulty and Starting Map - Side by Side -->
                                <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="1" Padding="8" CornerRadius="5">
                                    <StackPanel Spacing="8">
                                        <Grid ColumnDefinitions="2*,10,*">
                                            <StackPanel Grid.Column="0" Spacing="3">
                                                <TextBlock Text="Difficulty" Foreground="Tan" FontWeight="Bold"/>
                                                <ComboBox ItemsSource="{Binding DifficultyOptions}"
                                                          SelectedIndex="{Binding SelectedDifficulty}"
                                                          HorizontalAlignment="Stretch"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="2" Spacing="3">
                                                <TextBlock Text="Starting Map" Foreground="Tan" FontWeight="Bold"/>
                                                <ComboBox ItemsSource="{Binding AvailableMaps}"
                                                          SelectedItem="{Binding SelectedMapName}"
                                                          HorizontalAlignment="Stretch"
                                                          ToolTip.Tip="Select starting map from IWAD"/>
                                            </StackPanel>
                                        </Grid>
                                        
                                        <!-- Run Switches -->
                                        <StackPanel>
                                            
                                            <!-- First row of 3 checkboxes -->
                                            <UniformGrid Columns="3">
                                                <CheckBox Content="Fast Monsters" 
                                                          IsChecked="{Binding FastSwitch}"
                                                          ToolTip.Tip="Monsters run fast"
                                                          FontSize="11"/>   
                                                <CheckBox Content="No Monsters" 
                                                          IsChecked="{Binding NoMonstersSwitch}"
                                                          ToolTip.Tip="No Monsters"
                                                          FontSize="11"/>
                                                <CheckBox Content="Respawn Monsters" 
                                                          IsChecked="{Binding RespawnSwitch}"
                                                          ToolTip.Tip="Monsters respawn"
                                                          FontSize="11"/>
                                            </UniformGrid>
                                            
                                            <!-- Second row: Timer with input, Turbo with input -->
                                            <UniformGrid Columns="2">
                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                    <CheckBox Content="Timer" 
                                                              IsChecked="{Binding TimerSwitch}"
                                                              FontSize="11"
                                                              VerticalAlignment="Center"/>
                                                    <NumericUpDown Value="{Binding TimerMinutes}" 
                                                                   Minimum="1" Maximum="120" 
                                                                   Width="70"
                                                                   Height="24"
                                                                   FormatString="0"
                                                                   Increment="1"
                                                                   FontSize="11"
                                                                   IsEnabled="{Binding TimerSwitch}"
                                                                   VerticalAlignment="Center"
                                                                   ToolTip.Tip="Minutes"
                                                                   Classes="compact"/>
                                                </StackPanel>
                                                
                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                    <CheckBox Content="Turbo" 
                                                              IsChecked="{Binding TurboSwitch}"
                                                              FontSize="11"
                                                              VerticalAlignment="Center"/>
                                                    <NumericUpDown Value="{Binding TurboSpeed}" 
                                                                   Minimum="10" Maximum="255" 
                                                                   Width="70"
                                                                   Height="24"
                                                                   FormatString="0"
                                                                   Increment="5"
                                                                   FontSize="11"
                                                                   IsEnabled="{Binding TurboSwitch}"
                                                                   VerticalAlignment="Center"
                                                                   ToolTip.Tip="Speed %"
                                                                   Classes="compact"/>
                                                </StackPanel>
                                            </UniformGrid>
                                        </StackPanel>
                                    </StackPanel>
                            </Border>
                        </Grid>

                        <!-- New TabControl for Mods, Total Conversions, Multiplayer, DMFLAGS -->
                        <TabControl>
                        <!-- Mods/WADs Tab -->
                        <TabItem Header="Mods/WADs">
                            <!-- Mods Selection - Dual ListBox -->
                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                                    <StackPanel Spacing="5">
                                        <DockPanel>
                                            <TextBlock Text="Select Additional Files (WADs/PK3s)" Foreground="Tan" FontWeight="Bold" DockPanel.Dock="Left"/>
                                            <Button Content="Refresh" Command="{Binding RefreshFilesCommand}" 
                                                    DockPanel.Dock="Right" FontSize="10" Padding="5,2"
                                                    Margin="5,0,0,0"/>
                                        </DockPanel>
                                        
                                    
                                    <Grid ColumnDefinitions="*,Auto,*" Height="280">
                                        <!-- Available Mods (Left) -->
                                        <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
                                            <DockPanel>
                                                <TextBlock Text="Available Files" Foreground="LightGreen" FontWeight="SemiBold" FontSize="11"
                                                           DockPanel.Dock="Top" Margin="5,3"/>
                                                <ListBox ItemsSource="{Binding ModFiles}" 
                                                         SelectedItem="{Binding SelectedAvailableMod}"
                                                         Background="#40000000" FontSize="11">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <StackPanel ToolTip.Tip="{Binding MapList}">
                                                                <TextBlock Text="{Binding RelativePath}"/>
                                                                <TextBlock Text="{Binding Stats}" FontSize="9" Foreground="Gray"/>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                </ListBox>
                                            </DockPanel>
                                        </Border>
                                        
                                        <!-- Add/Remove Buttons (Center) -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="8,0" Spacing="5">
                                            <Button Command="{Binding AddModToLoadOrderCommand}"
                                                    HorizontalContentAlignment="Center"
                                                    Padding="2"
                                                    Background="Transparent"
                                                    ToolTip.Tip="Add selected mod to load order">
                                                <Image Source="/Assets/add.png" Width="24" Height="24"/>    
                                            </Button>
                                            <Button Command="{Binding RemoveModFromLoadOrderCommand}"
                                                    HorizontalContentAlignment="Center"
                                                    Padding="2"
                                                    Background="Transparent"
                                                    ToolTip.Tip="Remove selected mod from load order">
                                                <Image Source="/Assets/remove.png" Width="24" Height="24"/>
                                            </Button>
                                        </StackPanel>
                                        
                                        <!-- Selected Mods / Load Order (Right) -->
                                        <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
                                            <DockPanel>
                                                <TextBlock Text="Load Order (top = first)" Foreground="LightGreen" FontWeight="SemiBold" FontSize="11"
                                                           DockPanel.Dock="Top" Margin="5,3"/>
                                                <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" 
                                                            HorizontalAlignment="Center" Margin="0,5" Spacing="5">
                                                    <Button Command="{Binding MoveModUpCommand}" 
                                                            Padding="2"
                                                            Background="Transparent"
                                                            ToolTip.Tip="Move mod up in load order">
                                                        <Image Source="/Assets/up.png" Width="24" Height="24"/>
                                                    </Button>
                                                    <Button Command="{Binding MoveModDownCommand}" 
                                                           Padding="2"
                                                           Background="Transparent"
                                                            ToolTip.Tip="Move mod down in load order">
                                                        <Image Source="/Assets/down.png" Width="24" Height="24"/>
                                                    </Button>
                                                </StackPanel>
                                                <ListBox ItemsSource="{Binding SelectedModFiles}" 
                                                         SelectedItem="{Binding SelectedLoadOrderMod}"
                                                         Background="#40000000" FontSize="11">
                                                    <ListBox.ItemTemplate>
                                                        <DataTemplate>
                                                            <StackPanel Orientation="Horizontal" Spacing="5">
                                                                <TextBlock Text="{Binding LoadOrder}" FontWeight="Bold" 
                                                                           Foreground="LightGreen" Width="20"/>
                                                                <StackPanel ToolTip.Tip="{Binding MapList}">
                                                                    <TextBlock Text="{Binding RelativePath}"/>
                                                                    <TextBlock Text="{Binding Stats}" FontSize="9" Foreground="Gray"/>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </DataTemplate>
                                                    </ListBox.ItemTemplate>
                                                </ListBox>
                                            </DockPanel>
                                        </Border>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </TabItem>

                        <!-- Multiplayer Tab -->
                <TabItem Header="Multiplayer">
                    <ScrollViewer>
                        <StackPanel Spacing="15">
                            <!-- Game Type, Network Mode, and Number of Players -->
                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                                <Grid ColumnDefinitions="*,10,*,10,Auto">
                                    <!-- Game Type (Left) -->
                                    <StackPanel Grid.Column="0" Spacing="5">
                                        <TextBlock Text="Game Type" Foreground="Tan" FontWeight="Bold"/>
                                        <ComboBox ItemsSource="{Binding GameTypeOptions}"
                                                  SelectedItem="{Binding GameType}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource GameTypeDisplay}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </StackPanel>
                                    
                                    <!-- Network Mode (Center) -->
                                    <StackPanel Grid.Column="2" Spacing="5">
                                        <TextBlock Text="Network Mode" Foreground="Tan" FontWeight="Bold"/>
                                        <ComboBox ItemsSource="{Binding NetworkModeOptions}"
                                                  SelectedItem="{Binding NetworkMode}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource NetworkModeDisplay}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </StackPanel>
                                    
                                    <!-- Number of Players (Right) -->
                                    <StackPanel Grid.Column="4" Spacing="5"
                                                IsVisible="{Binding ShowPlayerCount}">
                                        <TextBlock Text="Players" Foreground="Tan" FontWeight="Bold"/>
                                        <NumericUpDown Value="{Binding PlayerCount}" 
                                                     Minimum="1" Maximum="8"
                                                     FormatString="0" Increment="1"
                                                     Width="100"
                                                     Foreground="White"
                                                     Background="#40404040"/>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <!-- IP Address Display - Shows when hosting -->
                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5"
                                    IsVisible="{Binding LocalIpAddress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Network Information" Foreground="Tan" FontWeight="Bold"/>
                                    
                                    <!-- IP Addresses Side by Side -->
                                    <Grid ColumnDefinitions="*,10,*">
                                        <!-- LAN IP - Left side -->
                                        <StackPanel Grid.Column="0" Spacing="3" 
                                                    IsVisible="{Binding LocalIpAddress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                            <TextBlock Text="ðŸ  Local (LAN) IP Address:" FontSize="11" Foreground="Gray"/>
                                            <Border Background="#30000000" Padding="8,4" CornerRadius="3">
                                                <TextBlock Text="{Binding LocalIpAddress}" 
                                                          FontFamily="Consolas" FontSize="13" FontWeight="SemiBold"
                                                          Foreground="LightGreen"/>
                                            </Border>
                                            <TextBlock Text="Players on your local network use this address" 
                                                      FontSize="10" Foreground="Gray" TextWrapping="Wrap"/>
                                        </StackPanel>
                                        
                                        <!-- Public IP - Right side -->
                                        <StackPanel Grid.Column="2" Spacing="3" 
                                                    IsVisible="{Binding PublicIpAddress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                            <TextBlock Text="ðŸŒ Public (Internet) IP Address:" FontSize="11" Foreground="Gray"/>
                                            <Border Background="#30000000" Padding="8,4" CornerRadius="3">
                                                <TextBlock Text="{Binding PublicIpAddress}" 
                                                          FontFamily="Consolas" FontSize="13" FontWeight="SemiBold"
                                                          Foreground="Orange"/>
                                            </Border>
                                            <TextBlock Text="Remote players use this address (requires port forwarding)" 
                                                      FontSize="10" Foreground="Gray" TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Grid>
                                    
                                    <!-- No IP detected message -->
                                    <TextBlock Text="âš ï¸ No IP addresses detected. Check your network connection." 
                                              FontSize="11" Foreground="Orange" TextWrapping="Wrap"
                                              IsVisible="{Binding LocalIpAddress, Converter={x:Static StringConverters.IsNullOrEmpty}}"/>
                                </StackPanel>
                            </Border>

                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5"
                                    IsVisible="{Binding ShowPortForwardingTest}">
                                <!-- Two-column layout: Header/Controls on left, Results on right -->
                                <Grid ColumnDefinitions="280,15,*" Height="90">
                                    <!-- Left Column: Header, Description, Buttons and Progress -->
                                    <StackPanel Grid.Column="0" Spacing="6" VerticalAlignment="Top">
                                        <TextBlock Text="Port Forwarding Test" Foreground="Tan" FontWeight="Bold"/>
                                        <TextBlock TextWrapping="Wrap" FontSize="10" Foreground="Gray" MaxWidth="270">
                                            Tests UPnP support and checks if UDP port 5029 is accessible for multiplayer hosting
                                        </TextBlock>
                                        
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <Button Content="Test Port" 
                                                    Command="{Binding TestPortForwardingCommand}"
                                                    IsEnabled="{Binding !IsTestingPort}"
                                                    Padding="8,4"
                                                    FontSize="11"
                                                    Background="#2060A0"
                                                    Foreground="White"
                                                    FontWeight="SemiBold"/>
                                            <Button Content="Auto-Configure" 
                                                    Command="{Binding AutoConfigurePortCommand}"
                                                    IsEnabled="{Binding !IsTestingPort}"
                                                    Padding="8,4"
                                                    FontSize="11"
                                                    Background="#406020"
                                                    Foreground="White"
                                                    FontWeight="SemiBold"
                                                    ToolTip.Tip="Automatically open UDP port 5029 using UPnP"/>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <!-- Progress Indicator - Fixed position, overlays on left column -->
                                    <Border Grid.Column="0" 
                                            IsVisible="{Binding IsTestingPort}" 
                                            Background="#80404040" 
                                            Padding="6" 
                                            CornerRadius="3"
                                            VerticalAlignment="Bottom"
                                            HorizontalAlignment="Left"
                                            Width="200"
                                            Height="25">
                                        <StackPanel Spacing="3" Orientation="Horizontal">
                                            <ProgressBar IsIndeterminate="True" Height="2" Width="120" VerticalAlignment="Center"/>
                                            <TextBlock Text="Testing..." 
                                                      FontSize="9" 
                                                      FontWeight="SemiBold"
                                                      Foreground="Orange"
                                                      VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Right Column: Results Only -->
                                    <Border Grid.Column="2" 
                                            Background="#20000000" 
                                            BorderBrush="#40808080" 
                                            BorderThickness="1"
                                            CornerRadius="3" 
                                            Padding="8"
                                            Opacity="{Binding PortTestResult, Converter={x:Static StringConverters.IsNotNullOrEmpty}, ConverterParameter='1;0.3'}">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                            <TextBlock Text="{Binding PortTestResult}" 
                                                      TextWrapping="NoWrap"
                                                      FontFamily="Consolas"
                                                      FontSize="10"/>
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <!-- DMFLAGS Tab -->
                <TabItem Header="DMFLAGS">
                    <TabControl>
                        <TabItem Header="DMFLAGS">
                            <ScrollViewer>
                                <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                                    <Grid ColumnDefinitions="*,*,*">
                                        <ItemsControl ItemsSource="{Binding DmFlags1Col1}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Label}" 
                                                            IsChecked="{Binding IsChecked}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <ItemsControl Grid.Column="1" ItemsSource="{Binding DmFlags1Col2}" Margin="10,0,0,0">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Label}" 
                                                            IsChecked="{Binding IsChecked}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <ItemsControl Grid.Column="2" ItemsSource="{Binding DmFlags1Col3}" Margin="10,0,0,0">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox Content="{Binding Label}" 
                                                            IsChecked="{Binding IsChecked}"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>
                                </Border>
                            </ScrollViewer>
                        </TabItem>
                    <TabItem Header="DMFLAGS2">
                        <ScrollViewer>
                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                                <ItemsControl ItemsSource="{Binding DmFlags2List}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="3"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Content="{Binding Label}" 
                                                    IsChecked="{Binding IsChecked}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Border>
                        </ScrollViewer>
                    </TabItem>
                    <TabItem Header="DMFLAGS3">
                        <ScrollViewer>
                            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" CornerRadius="5">
                                <ItemsControl ItemsSource="{Binding DmFlags3List}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="3"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <CheckBox Content="{Binding Label}" 
                                                    IsChecked="{Binding IsChecked}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Border>
                        </ScrollViewer>
                    </TabItem>
                    </TabControl>
                </TabItem>
            </TabControl>
        </StackPanel>

        <!-- Bottom Status and Controls -->
        <Grid Grid.Row="2" RowDefinitions="Auto,Auto" Margin="0,10,0,0">
                <!-- Row 0: Status Message (left) and Batocera Button (right) -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,8">
                    <!-- Status Message -->
                    <TextBlock Grid.Column="0"
                               Text="{Binding StatusMessage}" 
                               FontWeight="Bold"
                               Foreground="{Binding StatusMessageColor}"
                               TextWrapping="Wrap"
                               VerticalAlignment="Center"/>
                    
                    <!-- Batocera Config Button (only visible on Batocera) -->
                    <Button Grid.Column="1"
                            Command="{Binding SaveBatoceraConfigCommand}"
                            IsVisible="{Binding IsBatocera}"
                            Background="#604020"
                            FontWeight="SemiBold"
                            Padding="12,4"
                            Margin="10,0,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="Save .gzdoom Config" VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </Grid>
                
                <!-- Row 1: Zoom Controls (left) and Action Buttons (right) -->
                <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto">
                    <!-- Zoom Controls -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="5">
                        <Button Command="{Binding ZoomOutCommand}" 
                                ToolTip.Tip="Zoom Out (Ctrl -)"
                                Background="Transparent"
                                Width="32" Height="32" Padding="2">
                            <Image Source="/Assets/zoom-out.png" />
                        </Button>
                        <Button Command="{Binding ZoomInCommand}" 
                                ToolTip.Tip="Zoom In (Ctrl +)"
                                Background="Transparent"
                                Width="32" Height="32" Padding="2">
                            <Image Source="/Assets/zoom-in.png" />
                        </Button>
                        <Button Command="{Binding ResetZoomCommand}" 
                                ToolTip.Tip="Reset Zoom (Ctrl 0)"
                                Background="Transparent"
                                Width="32" Height="32" Padding="2">
                            <Image Source="/Assets/zoom-reset.png" />
                        </Button>
                        <TextBlock Text="{Binding ZoomLevel, StringFormat='{}{0}%'}" 
                                   VerticalAlignment="Center" Margin="5,0,0,0"
                                   FontWeight="SemiBold" MinWidth="40"/>
                    </StackPanel>
                    
                    <!-- Spacer -->
                    <Border Grid.Column="1"/>
                    
                    <!-- Action Buttons -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                        <Button Content="Exit" Command="{Binding ShowExitConfirmationCommand}" 
                               ToolTip.Tip="Save and exit the application"
                               Background="#A04040" 
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Reset" Command="{Binding ResetSettingsCommand}" 
                               ToolTip.Tip="Reset all settings to default values"
                               Background="#A06020" 
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Save Default" Command="{Binding SaveCurrentSettingsCommand}" 
                               ToolTip.Tip="Save current settings as defaults for next launch"
                               Background="#2060A0" 
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Load Preset" Command="{Binding LoadSettingsCommand}"
                               ToolTip.Tip="Load a saved .gzdoom preset file"
                               Background="#6040A0" 
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Save Preset" Command="{Binding SaveSettingsCommand}"
                               ToolTip.Tip="Save current settings to a .gzdoom preset file"
                               Background="#6040A0" 
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Summary" Command="{Binding ShowLaunchSummaryCommand}" 
                               ToolTip.Tip="Preview all settings and command line"
                               Background="DarkSlateGray"
                               Foreground="White"
                               FontWeight="SemiBold"/>
                        <Button Content="Launch" Command="{Binding LaunchGameCommand}" 
                               Background="#406020" 
                               Foreground="White" 
                               FontWeight="Bold" 
                               FontSize="14"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>
        </Panel>
    </Viewbox>
</Window>